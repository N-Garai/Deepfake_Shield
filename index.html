<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepfake Spy - AI Deepfake Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .heatmap-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .heatmap-region {
            position: absolute;
            border: 2px solid rgba(255, 0, 0, 0.7);
            background: radial-gradient(circle, rgba(255, 0, 0, 0.1) 0%, rgba(255, 0, 0, 0.6) 100%);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
    </style>
</head>

<body class="text-gray-200">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <main class="w-full max-w-2xl bg-gray-900/30 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700">
            <header class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white">Deepfake Spy</h1>
                <p class="text-indigo-300 mt-2">Uncover hidden truths with AI-powered deepfake detection.</p>
            </header>

            <!-- Main Interactive Area -->
            <div id="uploadArea">
                <div id="dropZone" class="relative block w-full h-48 p-4 text-center border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:border-indigo-400 transition-colors">
                    <div class="flex flex-col items-center justify-center h-full">
                        <svg class="w-12 h-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        <p class="mt-2 text-sm font-semibold text-gray-400">Click to upload or drag & drop</p>
                        <p class="text-xs text-gray-500">PNG, JPG, or WEBP</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/png, image/jpeg, image/webp">
                </div>
                <div class="mt-4">
                    <label for="imageUrl" class="text-sm font-medium text-gray-400">Or analyze from URL</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="imageUrl" placeholder="https://..." class="flex-grow bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                        <button id="fetchUrlBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fetch</button>
                    </div>
                </div>
            </div>

            <!-- Preview & Analyze Section -->
            <div id="previewContainer" class="hidden text-center mt-6">
                <p class="text-lg font-semibold mb-4">Image Ready for Analysis</p>
                <div class="relative inline-block border-2 border-gray-700 rounded-lg overflow-hidden">
                    <img id="imagePreview" src="" alt="Image Preview" class="max-w-xs max-h-64 object-contain rounded-md">
                    <div id="heatmapOverlay" class="heatmap-overlay"></div>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-3">
                    <button id="analyzeBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Analyze Image</button>
                    <button id="resetBtn" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">Try Another</button>
                    <button id="showExifBtn" class="hidden w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">Show EXIF Data</button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="resultsContainer" class="hidden mt-6">
                <div id="loadingState" class="text-center p-6">
                    <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-lg font-semibold text-white">AI Analysis in Progress...</p>
                    <p class="text-sm text-gray-400">This can take a few moments.</p>
                </div>
                <div id="resultsContent" class="hidden">
                    <h2 class="text-2xl font-bold text-center text-white mb-6">Analysis Result</h2>
                    <div class="bg-gray-900/50 rounded-lg p-6 flex flex-col md:flex-row items-center gap-6">
                        <div class="relative w-36 h-36 flex items-center justify-center">
                            <svg class="w-full h-full" viewBox="0 0 120 120"><circle class="text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="56" cx="60" cy="60" /><circle id="progressCircle" class="progress-ring__circle text-indigo-400" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="56" cx="60" cy="60" /></svg>
                            <span id="probabilityText" class="absolute text-3xl font-bold">0%</span>
                        </div>
                        <div class="flex-1 text-center md:text-left">
                            <p class="text-lg font-medium text-gray-400">Likelihood of Deepfake</p>
                            <p id="verdictText" class="text-2xl font-bold mt-1">Calculating...</p>
                            <div id="analysisBox" class="mt-4 text-sm text-gray-400 bg-gray-800 p-3 rounded-md max-h-40 overflow-y-auto"><p id="analysisText">Waiting for analysis...</p></div>
                        </div>
                    </div>
                    <div id="forensicsReport" class="mt-6 hidden">
                        <h3 class="text-xl font-bold text-center text-white mb-4">Forensic Breakdown</h3>
                        <div id="forensicsList" class="space-y-3"></div>
                    </div>
                </div>
                <div id="errorState" class="hidden text-center text-red-400 bg-red-900/50 p-4 rounded-lg">
                    <p><strong>Analysis Failed</strong></p>
                    <p id="errorMessage" class="text-sm mt-1">An unknown error occurred.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- EXIF Modal -->
    <div id="exifModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">EXIF Metadata</h3>
                <button id="closeExifBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="exifDataContainer" class="p-4 overflow-y-auto text-sm"></div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imageUrlInput = document.getElementById('imageUrl');
        const fetchUrlBtn = document.getElementById('fetchUrlBtn');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loadingState = document.getElementById('loadingState');
        const resultsContent = document.getElementById('resultsContent');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const probabilityText = document.getElementById('probabilityText');
        const verdictText = document.getElementById('verdictText');
        const analysisText = document.getElementById('analysisText');
        const progressCircle = document.getElementById('progressCircle');
        const forensicsReport = document.getElementById('forensicsReport');
        const forensicsList = document.getElementById('forensicsList');
        const exifModal = document.getElementById('exifModal');
        const showExifBtn = document.getElementById('showExifBtn');
        const closeExifBtn = document.getElementById('closeExifBtn');
        const exifDataContainer = document.getElementById('exifDataContainer');
        const heatmapOverlay = document.getElementById('heatmapOverlay');

        let fileObject = null;
        let base64ImageData = null;
        let lastApiCallTimestamp = 0;

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-400'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-indigo-400'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-400');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        fetchUrlBtn.addEventListener('click', handleUrlFetch);
        resetBtn.addEventListener('click', resetUI);
        analyzeBtn.addEventListener('click', performAnalysis);

        // --- UI Functions ---
        function handleFile(file) {
            if (!file.type.startsWith('image/')) { alert('Please upload an image file.'); return; }
            fileObject = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                base64ImageData = e.target.result.split(',')[1];
                uploadArea.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                analyzeBtn.disabled = false;
                readExifData(file);
            };
            reader.readAsDataURL(file);
        }

        async function handleUrlFetch() {
            const url = imageUrlInput.value.trim();
            if (!url) { alert('Please enter a valid image URL.'); return; }
            try {
                const proxyUrl = `https://proxy.cors.sh/${url}`;
                const response = await fetch(proxyUrl, { headers: { 'x-cors-api-key': 'temp_61e15147425c28059089783f99b3b841' } });
                if (!response.ok) throw new Error(`Failed to fetch image. Status: ${response.status}`);
                const blob = await response.blob();
                handleFile(new File([blob], "fetched_image.jpg", { type: blob.type }));
            } catch (error) {
                console.error("URL Fetch Error:", error);
                alert(`Could not load image from URL: ${error.message}`);
            }
        }

        function resetUI() {
            fileObject = null;
            base64ImageData = null;
            fileInput.value = '';
            imageUrlInput.value = '';
            uploadArea.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            analyzeBtn.disabled = true;
            resultsContainer.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorState.classList.add('hidden');
            showExifBtn.classList.add('hidden');
            forensicsReport.classList.add('hidden');
            heatmapOverlay.innerHTML = '';
        }

        function readExifData(file) {
            EXIF.getData(file, function() {
                const allTags = EXIF.getAllTags(this);
                if (Object.keys(allTags).length === 0) { showExifBtn.classList.add('hidden'); return; }
                let tableHtml = '<table class="w-full text-left text-gray-300">';
                for (let tag in allTags) {
                    if (allTags.hasOwnProperty(tag)) tableHtml += `<tr><td class="font-semibold p-2">${tag}</td><td class="p-2">${allTags[tag]}</td></tr>`;
                }
                tableHtml += '</table>';
                exifDataContainer.innerHTML = tableHtml;
                showExifBtn.classList.remove('hidden');
            });
        }
        showExifBtn.addEventListener('click', () => exifModal.classList.remove('hidden'));
        closeExifBtn.addEventListener('click', () => exifModal.classList.add('hidden'));
        exifModal.addEventListener('click', (e) => { if (e.target === exifModal) exifModal.classList.add('hidden'); });

        // --- AI Analysis ---
        async function performAnalysis() {
            if (!fileObject) { showError("No file selected for analysis."); return; }

            const now = Date.now();
            const COOLDOWN_PERIOD = 10000;
            if (now - lastApiCallTimestamp < COOLDOWN_PERIOD) {
                const timeLeft = Math.ceil((COOLDOWN_PERIOD - (now - lastApiCallTimestamp)) / 1000);
                showError(`Please wait ${timeLeft} more seconds before the next analysis.`);
                return;
            }

            resultsContainer.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            analyzeBtn.disabled = true;
            lastApiCallTimestamp = Date.now();

            const payload = {
                mimeType: fileObject.type,
                imageData: base64ImageData
            };

            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('API Error:', error);
                showError(`Analysis failed: ${error.message}`);
                analyzeBtn.disabled = false;
            }
        }

        function displayResults(data) {
            loadingState.classList.add('hidden');
            resultsContent.classList.remove('hidden');

            const probability = Math.round(data.probability);
            probabilityText.textContent = `${probability}%`;
            verdictText.textContent = data.verdict;
            analysisText.textContent = data.analysis;

            const circumference = 2 * Math.PI * 56;
            const offset = circumference - (probability / 100) * circumference;
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = offset;
            
            progressCircle.classList.remove('text-indigo-400', 'text-yellow-400', 'text-red-400');
            verdictText.classList.remove('text-indigo-400', 'text-yellow-400', 'text-red-400');
            if (probability >= 75) {
                progressCircle.classList.add('text-red-400');
                verdictText.classList.add('text-red-400');
            } else if (probability >= 40) {
                progressCircle.classList.add('text-yellow-400');
                verdictText.classList.add('text-yellow-400');
            } else {
                progressCircle.classList.add('text-indigo-400');
                verdictText.classList.add('text-indigo-400');
            }

            forensicsList.innerHTML = '';
            if (data.forensics && data.forensics.length > 0) {
                data.forensics.forEach(item => {
                    const score = Math.round(item.score);
                    let colorClass = 'bg-indigo-500', textColorClass = 'text-indigo-300';
                    if (score >= 75) { colorClass = 'bg-red-500'; textColorClass = 'text-red-300'; } 
                    else if (score >= 40) { colorClass = 'bg-yellow-500'; textColorClass = 'text-yellow-300'; }
                    const reportItem = `
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-1">
                                <p class="font-semibold text-sm">${item.category}</p>
                                <p class="font-bold text-sm ${textColorClass}">${score}%</p>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2"><div class="${colorClass} h-2 rounded-full" style="width: ${score}%"></div></div>
                            <p class="text-xs text-gray-400 mt-2">${item.reason}</p>
                        </div>`;
                    forensicsList.innerHTML += reportItem;
                });
                forensicsReport.classList.remove('hidden');
            } else {
                 forensicsReport.classList.add('hidden');
            }

            heatmapOverlay.innerHTML = '';
            if (data.heatmap_regions && data.heatmap_regions.length > 0) {
                data.heatmap_regions.forEach(region => {
                    const regionEl = document.createElement('div');
                    regionEl.className = 'heatmap-region';
                    regionEl.style.left = `${region.x}%`;
                    regionEl.style.top = `${region.y}%`;
                    regionEl.style.width = `${region.width}%`;
                    regionEl.style.height = `${region.height}%`;
                    regionEl.style.opacity = region.confidence * 0.8 + 0.2;
                    heatmapOverlay.appendChild(regionEl);
                });
            }
        }
        
        function showError(message) {
            loadingState.classList.add('hidden');
            resultsContent.classList.add('hidden');
            errorMessage.textContent = message;
            errorState.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>